server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name ai-model.style-metrics.com;

    # Redirect all HTTP to HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2 default_server;
    listen [::]:443 ssl http2 default_server;
    server_name ai-model.style-metrics.com;

    # ssl_certificate      /etc/letsencrypt/live/ai-model.style-metrics.com/fullchain.pem;
    # ssl_certificate_key  /etc/letsencrypt/live/ai-model.style-metrics.com/privkey.pem;

    client_max_body_size 10M;

    # Send EVERYTHING (/, /api/config, /api/graphql, etc.) to the Wren UI
    location / {
        proxy_pass http://wren-ui:3000;

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        add_header Access-Control-Allow-Origin "https://stylemetrics-data-mgmt.web.app" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
        add_header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS" always;

        # OPTIONS request handler (important!)
        if ($request_method = OPTIONS) {
            return 204;
        }

        # Basic auth
        auth_basic           "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        # Websocket / HTTP1.1 upgrade support
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
